const puppeteer = require('puppeteer');

const PROD_URL = 'https://sales-management-412055180465.europe-west1.run.app';

async function sleep(ms) {
  return new Promise(resolve => setTimeout(resolve, ms));
}

async function testCompleteFlow() {
  console.log('ğŸš€ COMPLETE FLOW TEST - Simplified\n');
  console.log(`ğŸ“ URL: ${PROD_URL}\n`);

  const browser = await puppeteer.launch({
    headless: false,
    args: ['--no-sandbox', '--disable-setuid-sandbox', '--start-maximized'],
    defaultViewport: null,
    slowMo: 80
  });

  try {
    const page = await browser.newPage();

    // ============================================================================
    // STEP 1: LOGIN AS ADMIN
    // ============================================================================
    console.log('ğŸ“± STEP 1: Admin Login\n');

    await page.goto(PROD_URL, { waitUntil: 'networkidle2', timeout: 30000 });
    await sleep(2000);

    await page.screenshot({ path: 'test-results/simple-01-login.png', fullPage: true });

    // Login as admin
    await page.waitForSelector('input[type="email"]', { timeout: 10000 });
    await page.type('input[type="email"]', 'admin@vr.com', { delay: 50 });
    await page.type('input[type="password"]', 'Admin123!', { delay: 50 });
    await page.click('button[type="submit"]');

    console.log('   â†’ Login submitted...');
    await sleep(5000);

    await page.screenshot({ path: 'test-results/simple-02-admin-dashboard.png', fullPage: true });
    console.log('   âœ… Admin logged in\n');

    // ============================================================================
    // STEP 2: GENERATE TASKS FOR EXISTING USER
    // ============================================================================
    console.log('ğŸ“± STEP 2: Generate Tasks for Seller\n');

    // Navigate to AI Task Manager
    await page.goto(`${PROD_URL}/admin/ai-tasks`, { waitUntil: 'networkidle2' });
    await sleep(2000);

    await page.screenshot({ path: 'test-results/simple-03-ai-tasks-page.png', fullPage: true });
    console.log('   âœ… Screenshot: simple-03-ai-tasks-page.png');

    // Click on a seller (Aya Ftissi)
    console.log('   â†’ Clicking on seller "Aya Ftissi"...');
    const sellerClicked = await page.evaluate(() => {
      // Find all buttons and look for one containing "Aya Ftissi"
      const buttons = Array.from(document.querySelectorAll('button'));
      const ayaButton = buttons.find(btn => {
        const text = btn.textContent || '';
        return text.includes('Aya Ftissi') || text.includes('Ftissi');
      });

      if (ayaButton) {
        ayaButton.click();
        return true;
      }
      return false;
    });

    if (!sellerClicked) {
      console.log('   âš ï¸  Could not find Aya Ftissi, trying first seller button...');
      await page.evaluate(() => {
        // Look for seller buttons in the sellers list
        const buttons = Array.from(document.querySelectorAll('button'));
        // Find a button that has seller-like content (displayName + team)
        const sellerBtn = buttons.find(btn => {
          const hasInitial = btn.querySelector('[class*="rounded-full"]');
          const hasName = btn.textContent && btn.textContent.length > 10;
          return hasInitial && hasName;
        });
        if (sellerBtn) sellerBtn.click();
      });
    }

    await sleep(3000);
    await page.screenshot({ path: 'test-results/simple-03b-seller-selected.png', fullPage: true });
    console.log('   âœ… Seller selected: Aya Ftissi\n');

    // Enter text in the prompt field
    console.log('   â†’ Entering custom prompt for AI...');
    const textarea = await page.waitForSelector('textarea', { timeout: 5000 });
    await textarea.click();
    await sleep(500);
    await textarea.type('Genera 3 task urgenti per oggi: chiamate ai clienti principali, follow-up sui deals aperti, e ricerca nuovi contatti. Assicurati che ogni task abbia il formato expectedOutputFormat con documentRequired: true', { delay: 30 });
    console.log('   âœ… Prompt entered');
    await sleep(2000);

    await page.screenshot({ path: 'test-results/simple-03c-prompt-entered.png', fullPage: true });

    // Click "Genera Task AI" button
    console.log('   â†’ Clicking "Genera Task AI" button...');
    const generateBtn = await page.evaluateHandle(() => {
      const buttons = Array.from(document.querySelectorAll('button'));
      return buttons.find(btn =>
        btn.textContent.includes('Genera Task AI') ||
        btn.textContent.includes('ğŸš€ Genera Task AI')
      );
    });

    if (generateBtn) {
      await generateBtn.asElement()?.click();
      console.log('   âœ… Clicked generate button');

      console.log('   âœ… Task generation started...');
      console.log('   â³ Waiting 35 seconds for AI to generate tasks...\n');

      // Show progress
      for (let i = 0; i < 7; i++) {
        await sleep(5000);
        console.log(`      ${(i + 1) * 5} seconds...`);
      }

      await page.screenshot({ path: 'test-results/simple-05-tasks-generated.png', fullPage: true });
      console.log('\n   âœ… Screenshot: simple-05-tasks-generated.png');

      // Check if tasks were generated
      const tasksGenerated = await page.evaluate(() => {
        const text = document.body.textContent;
        return text.includes('Task Consigliati') || text.includes('Conferma');
      });

      if (tasksGenerated) {
        console.log('   âœ… AI generated suggested tasks\n');

        // Click "Conferma Tutti" button to save all tasks
        console.log('   â†’ Confirming all generated tasks...');
        const confirmed = await page.evaluate(() => {
          const buttons = Array.from(document.querySelectorAll('button'));
          const confirmBtn = buttons.find(btn =>
            btn.textContent.includes('Conferma Tutti') ||
            btn.textContent.includes('âœ… Conferma Tutti')
          );
          if (confirmBtn && !confirmBtn.disabled) {
            confirmBtn.click();
            return true;
          }
          return false;
        });

        if (confirmed) {
          console.log('   âœ… Clicked confirm button');
          await sleep(3000);

          // Handle the browser confirm dialog
          page.on('dialog', async dialog => {
            console.log(`   â†’ Accepting confirmation dialog: "${dialog.message().substring(0, 50)}..."`);
            await dialog.accept();
          });

          await sleep(2000);
          console.log('   âœ… Tasks confirmed and saved to Firestore\n');

          await page.screenshot({ path: 'test-results/simple-05b-tasks-confirmed.png', fullPage: true });
        }
      }

      // ============================================================================
      // STEP 3: LOGOUT AND LOGIN AS SELLER
      // ============================================================================
      console.log('\nğŸ“± STEP 3: Login as Seller\n');

      // Logout
      await page.evaluate(() => {
        const buttons = Array.from(document.querySelectorAll('button, a'));
        const logoutBtn = buttons.find(btn =>
          btn.textContent.includes('Logout') ||
          btn.textContent.includes('Esci')
        );
        if (logoutBtn) logoutBtn.click();
      });

      await sleep(3000);

      // Go to login
      await page.goto(PROD_URL, { waitUntil: 'networkidle2' });
      await sleep(2000);

      // Login as Aya Ftissi
      const sellerLoginEmail = 'ftissiaya@gmail.com';
      const sellerPassword = 'Seller123!'; // Default password

      console.log(`   â†’ Logging in as Aya Ftissi: ${sellerLoginEmail}`);

      await page.waitForSelector('input[type="email"]', { timeout: 10000 });
      await page.type('input[type="email"]', sellerLoginEmail, { delay: 50 });
      await page.type('input[type="password"]', sellerPassword, { delay: 50 });
      await page.click('button[type="submit"]');

      await sleep(5000);

      await page.screenshot({ path: 'test-results/simple-06-seller-dashboard.png', fullPage: true });
      console.log('   âœ… Seller logged in\n');

      // ============================================================================
      // STEP 4: CHECK TASKS ON /TODAY PAGE
      // ============================================================================
      console.log('ğŸ“± STEP 4: Check Tasks on /today Page\n');

      await page.goto(`${PROD_URL}/today`, { waitUntil: 'networkidle2' });
      console.log('   â³ Waiting for briefing to load...');
      await sleep(8000);

      await page.screenshot({ path: 'test-results/simple-07-today-page.png', fullPage: true });
      console.log('   âœ… Screenshot: simple-07-today-page.png');

          // Check tasks
          const tasksInfo = await page.evaluate(() => {
            const taskButtons = Array.from(document.querySelectorAll('button')).filter(btn =>
              btn.textContent.includes('Inizia')
            );

            const taskTitles = Array.from(document.querySelectorAll('h3, h4')).filter(el =>
              el.textContent.length > 10 && el.textContent.length < 200
            ).map(el => el.textContent.trim()).slice(0, 5);

            return {
              hasInitButtons: taskButtons.length > 0,
              initButtonsCount: taskButtons.length,
              taskTitles
            };
          });

          console.log(`   â†’ Found ${tasksInfo.initButtonsCount} "Inizia" buttons`);
          if (tasksInfo.taskTitles.length > 0) {
            console.log('   â†’ Task titles found:');
            tasksInfo.taskTitles.forEach((title, i) => {
              console.log(`      ${i + 1}. ${title.substring(0, 80)}`);
            });
          }

          if (tasksInfo.hasInitButtons) {
            console.log('\n   â†’ Opening first task...');

            const taskOpened = await page.evaluate(() => {
              const buttons = Array.from(document.querySelectorAll('button'));
              const iniziaBtn = buttons.find(btn => btn.textContent.includes('Inizia'));
              if (iniziaBtn) {
                iniziaBtn.scrollIntoView({ behavior: 'smooth', block: 'center' });
                setTimeout(() => iniziaBtn.click(), 500);
                return true;
              }
              return false;
            });

            await sleep(3000);

            if (taskOpened) {
              console.log('   âœ… Task modal opened\n');

              await page.screenshot({ path: 'test-results/simple-08-task-modal-top.png', fullPage: false });

              // ============================================================================
              // STEP 5: VERIFY EXPECTED OUTPUT FORMAT
              // ============================================================================
              console.log('ğŸ“± STEP 5: Verify Expected Output Format & Upload Section\n');

              const verificationResults = await page.evaluate(() => {
                const text = document.body.textContent;

                // Check for key elements
                const results = {
                  hasOBBLIGATORIO: text.includes('OBBLIGATORIO'),
                  hasDocumentoDaCaricare: text.includes('DOCUMENTO DA CARICARE'),
                  hasCaricaRisultati: text.includes('Carica Risultati') || text.includes('Carica'),
                  hasFileInput: document.querySelector('input[type="file"]') !== null,
                  redSections: Array.from(document.querySelectorAll('div')).filter(div =>
                    div.className.includes('bg-red') && div.className.includes('border-red')
                  ).length,
                };

                // Check text color in inputs
                const inputs = Array.from(document.querySelectorAll('input[type="number"], textarea'));
                results.textColors = inputs.map(input => {
                  const style = window.getComputedStyle(input);
                  const color = style.color;
                  const isWhite = color === 'rgb(255, 255, 255)' || color.includes('255, 255, 255');
                  return { element: input.tagName, color, isWhite };
                });

                return results;
              });

              console.log('   ğŸ“‹ Verification Results:');
              console.log(`      âœ“ "OBBLIGATORIO" text: ${verificationResults.hasOBBLIGATORIO ? 'âœ… YES' : 'âŒ NO'}`);
              console.log(`      âœ“ "DOCUMENTO DA CARICARE": ${verificationResults.hasDocumentoDaCaricare ? 'âœ… YES' : 'âŒ NO'}`);
              console.log(`      âœ“ "Carica Risultati": ${verificationResults.hasCaricaRisultati ? 'âœ… YES' : 'âŒ NO'}`);
              console.log(`      âœ“ File input present: ${verificationResults.hasFileInput ? 'âœ… YES' : 'âŒ NO'}`);
              console.log(`      âœ“ Red sections: ${verificationResults.redSections} ${verificationResults.redSections > 0 ? 'âœ…' : 'âŒ'}`);

              console.log('\n   ğŸ¨ Text Color Check:');
              verificationResults.textColors.forEach((info, i) => {
                const status = info.isWhite ? 'âŒ WHITE!' : 'âœ… Visible';
                console.log(`      ${i + 1}. ${info.element}: ${info.color} ${status}`);
              });

              const allTextVisible = verificationResults.textColors.every(c => !c.isWhite);
              console.log(`\n      Overall: ${allTextVisible ? 'âœ… All text is visible' : 'âš ï¸  Some text may be white'}`);

              // Scroll to upload section
              console.log('\n   â†’ Scrolling to file upload section...');
              await page.evaluate(() => {
                const modal = document.querySelector('[class*="overflow-y-auto"]');
                if (modal) {
                  modal.scrollTop = modal.scrollHeight;
                } else {
                  window.scrollTo(0, document.body.scrollHeight);
                }
              });
              await sleep(2000);

              await page.screenshot({ path: 'test-results/simple-09-upload-section.png', fullPage: false });
              console.log('   âœ… Screenshot: simple-09-upload-section.png');

              // ============================================================================
              // STEP 6: TEST VALIDATION
              // ============================================================================
              console.log('\nğŸ“± STEP 6: Test Validation (Complete Without File)\n');

              // Fill fields
              await page.evaluate(() => {
                const durationInput = document.querySelector('input[type="number"]');
                if (durationInput) durationInput.value = '20';

                const textarea = document.querySelector('textarea');
                if (textarea) textarea.value = 'Test validation - trying to complete without uploading file';
              });

              await sleep(1000);

              // Listen for alert
              let alertShown = false;
              let alertMessage = '';

              page.once('dialog', async dialog => {
                alertShown = true;
                alertMessage = dialog.message();
                await dialog.accept();
              });

              // Try to complete
              console.log('   â†’ Attempting to complete task without file...');
              const completeClicked = await page.evaluate(() => {
                const buttons = Array.from(document.querySelectorAll('button'));
                const completeBtn = buttons.find(btn => btn.textContent.includes('Completa'));
                if (completeBtn) {
                  completeBtn.click();
                  return true;
                }
                return false;
              });

              await sleep(2000);

              if (alertShown) {
                console.log(`   âœ… VALIDATION WORKS! Alert shown:`);
                console.log(`      "${alertMessage.substring(0, 120)}..."`);
              } else {
                console.log('   âš ï¸  No alert - validation may not be working');
              }

              await page.screenshot({ path: 'test-results/simple-10-validation-test.png', fullPage: false });
              console.log('   âœ… Screenshot: simple-10-validation-test.png');

              // ============================================================================
              // FINAL SUMMARY
              // ============================================================================
              console.log('\n' + '='.repeat(80));
              console.log('ğŸ“Š TEST SUMMARY');
              console.log('='.repeat(80) + '\n');

              const allChecksPassed =
                verificationResults.hasOBBLIGATORIO &&
                verificationResults.hasDocumentoDaCaricare &&
                verificationResults.hasFileInput &&
                verificationResults.redSections > 0 &&
                allTextVisible &&
                alertShown;

              console.log('âœ… Steps Completed:');
              console.log('  1. âœ“ Admin login');
              console.log('  2. âœ“ Generate tasks for seller');
              console.log('  3. âœ“ Login as seller');
              console.log('  4. âœ“ View tasks on /today');
              console.log('  5. âœ“ Open task modal');
              console.log('  6. âœ“ Verify expectedOutputFormat section');
              console.log('  7. âœ“ Verify file upload section');
              console.log('  8. âœ“ Verify text visibility');
              console.log('  9. âœ“ Test validation\n');

              console.log('ğŸ“Š Verification Results:');
              console.log(`  - expectedOutputFormat visible: ${verificationResults.hasDocumentoDaCaricare ? 'âœ…' : 'âŒ'}`);
              console.log(`  - Upload section visible: ${verificationResults.hasFileInput ? 'âœ…' : 'âŒ'}`);
              console.log(`  - Red warning sections: ${verificationResults.redSections > 0 ? 'âœ…' : 'âŒ'} (${verificationResults.redSections} found)`);
              console.log(`  - Text color correct: ${allTextVisible ? 'âœ…' : 'âŒ'}`);
              console.log(`  - Validation works: ${alertShown ? 'âœ…' : 'âŒ'}\n`);

              console.log(`ğŸ¯ FINAL RESULT: ${allChecksPassed ? 'âœ… ALL CHECKS PASSED!' : 'âš ï¸  Some checks failed'}\n`);

              console.log('ğŸ“¸ All screenshots saved in test-results/\n');
            }
          } else {
            console.log('   âš ï¸  No tasks found for seller\n');
          }
        }
      }
    } else {
      console.log('   âš ï¸  Could not find or click generate button\n');
    }

    console.log('\nKeeping browser open for 10 seconds...');
    await sleep(10000);

  } catch (error) {
    console.error('\nâŒ Test error:', error);
    await page.screenshot({ path: 'test-results/simple-ERROR.png', fullPage: true });
  } finally {
    await browser.close();
  }
}

// Run
(async () => {
  try {
    await testCompleteFlow();
    console.log('âœ… Test completed successfully!\n');
    process.exit(0);
  } catch (error) {
    console.error('âŒ Test failed:', error);
    process.exit(1);
  }
})();
